#!/usr/bin/env ruby

require 'optparse'
require 'suj/pusher'
require 'fileutils'
require 'daemon_spawn'


BANNER = "Usage: pusher start|stop|restart|status [options]"
WORKDIR = Dir.pwd

class PusherDaemon < DaemonSpawn::Base
  def start(args)
    config = Suj::Pusher::Configuration.new
    args.options do |opts|
      opts.banner = BANNER
      opts.on('-r REDIS', '--redis REDIS', String, 'Redis server to connect') { |redis| config.redis = redis }
      opts.on('-v', '--version', 'Print this version of rapns.') { puts "rapns #{Suj::Pusher::VERSION}"; exit }
      opts.on('-h', '--help', 'You\'re looking at it.') { puts opts; exit }
      opts.parse!
    end

    config.certs_path = File.join(WORKDIR, "certs")
    FileUtils.mkdir_p(config.certs_path)
    FileUtils.mkdir_p(File.join(WORKDIR, "logs"))
    FileUtils.mkdir_p(File.join(WORKDIR, "tmp/pids"))
    Suj::Pusher.config.update(config)

    @daemon = Suj::Pusher::Daemon.new
    @daemon.start
  end

  def stop
    @daemon.stop
  end
end

PusherDaemon.spawn!(
  sync_log: true,
  working_dir: Dir.pwd
)
